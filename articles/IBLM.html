<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>IBLM • IBLM</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="IBLM">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">IBLM</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/IBLM.html">IBLM</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/figures/iblm_paper.pdf">Paper</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/IFoA-ADSWP/IBLM/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>IBLM</h1>
                        <h4 data-toc-skip class="author">Karol Gawlowski
and Paul Beard</h4>
            
            <h4 data-toc-skip class="date">2025-12-08</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/IFoA-ADSWP/IBLM/blob/main/vignettes/IBLM.Rmd" class="external-link"><code>vignettes/IBLM.Rmd</code></a></small>
      <div class="d-none name"><code>IBLM.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>IBLM can be installed from CRAN or GitHub:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># From CRAN</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"IBLM"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># From GitHub</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"IFoA-ADSWP/IBLM"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>IBLM stands for “Interpretable Boosted Linear Model”.</p>
<p>An IBLM is essentially a hybrid model consisting of two
components:</p>
<ol style="list-style-type: decimal">
<li><p>Generalised Linear Model (GLM) - fitted to the training
data</p></li>
<li><p>Booster Model<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;As of v.1.0.0 the IBLM package can only fit a booster
model of type XGBoost, however we are looking to add other options in
the future.&lt;/p&gt;"><sup>1</sup></a> - fitted to the residuals of the training
data against GLM predictions in step 1.</p></li>
</ol>
<p>The purpose of this article is to show you how to use IBLM to train,
explain and predict using functions from this package.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ifoa-adswp.github.io/IBLM/">IBLM</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="theory">Theory<a class="anchor" aria-label="anchor" href="#theory"></a>
</h2>
<p>The overall process for fitting and interpreting an IBLM is as
follows:</p>
<p><strong>Step 1: Fit a GLM</strong></p>
<div class="eq-block">
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>μ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>β</mi><mn>0</mn></msub><mo>+</mo><msub><mi>β</mi><mn>1</mn></msub><msub><mi>x</mi><mn>1</mn></msub><mo>+</mo><msub><mi>β</mi><mn>2</mn></msub><msub><mi>x</mi><mn>2</mn></msub><mo>+</mo><mi>⋯</mi><mo>+</mo><msub><mi>β</mi><mi>n</mi></msub><msub><mi>x</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">
g(\mu) = \beta_0 + \beta_1 x_1 + \beta_2 x_2 + \cdots + \beta_n x_n
</annotation></semantics></math></p>
</div>
<p>Where g(·) is the link function, μ is the expected value of the
response, and β values are your standard regression coefficients.</p>
<div class="eq-block">
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">GLM prediction</mtext><mo>=</mo><msup><mi>g</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>β</mi><mn>0</mn></msub><mo>+</mo><msub><mi>β</mi><mn>1</mn></msub><msub><mi>x</mi><mn>1</mn></msub><mo>+</mo><msub><mi>β</mi><mn>2</mn></msub><msub><mi>x</mi><mn>2</mn></msub><mo>+</mo><mi>⋯</mi><mo>+</mo><msub><mi>β</mi><mi>n</mi></msub><msub><mi>x</mi><mi>n</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
\text{GLM prediction} = g^{-1} (\beta_0 + \beta_1 x_1 + \beta_2 x_2 + \cdots + \beta_n x_n)
</annotation></semantics></math></p>
</div>
<p>Where β values are your standard regression coefficients.</p>
<p><strong>Step 2: Train a Booster on GLM’s Errors</strong></p>
<p>Train a booster model (i.e. XGBoost) on the residuals of the actual
response values against the GLM predictions.</p>
<p><strong>Step 3: Use SHAP to Break Down the Booster</strong></p>
<p>SHAP decomposition allows the booster’s prediction to be apportioned
into contributions from each feature:</p>
<div class="eq-block">
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">Booster prediction</mtext><mo>=</mo><msup><mi>g</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>φ</mi><mn>0</mn></msub><mo>+</mo><msub><mi>φ</mi><mn>1</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><msub><mi>φ</mi><mn>2</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mi>⋯</mi><mo>+</mo><msub><mi>φ</mi><mi>n</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
\text{Booster prediction} = g^{-1} (\varphi_0 + \varphi_1(x) + \varphi_2(x) + \cdots + \varphi_n(x))
</annotation></semantics></math></p>
</div>
<p>Where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>φ</mi><mi>j</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\varphi_j(x)</annotation></semantics></math>
is how much feature j contributed to a specific prediction.</p>
<p><strong>Step 4: Convert SHAP Values to Beta Coefficient
Corrections</strong></p>
<p>Transform each SHAP contribution into beta corrections:</p>
<div class="eq-block">
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mi>j</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>≈</mo><mfrac><mrow><msub><mi>φ</mi><mi>j</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><msub><mi>x</mi><mi>j</mi></msub></mfrac></mrow><annotation encoding="application/x-tex">
\alpha_j(x) \approx \frac{\varphi_j(x)}{x_j}
</annotation></semantics></math></p>
</div>
<p>There are two situations where the value of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mi>j</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\alpha_j(x)</annotation></semantics></math>
is set to zero and the value for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>φ</mi><mi>j</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\varphi_j(x)</annotation></semantics></math>
is added to the intercept instead. This is when
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>x</mi><annotation encoding="application/x-tex">x</annotation></semantics></math>
is a numerical variable, and the value is zero. Or, when
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>x</mi><annotation encoding="application/x-tex">x</annotation></semantics></math>
is a categorical variable, and the value is that of the reference
level<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;The reference level of a categorical variable is the
value that is the value for which there is no coefficient in the GLM.
The reference levels of an “iblm” class object can be found in
&lt;code&gt;.$cat_levels$reference&lt;/code&gt;&lt;/p&gt;"><sup>2</sup></a>.</p>
<div class="eq-block">
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>α</mi><mi>j</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mn>0</mn><mrow><mspace width="0.333em"></mspace><mtext mathvariant="normal"> when </mtext><mspace width="0.333em"></mspace></mrow><mrow><mo stretchy="true" form="prefix">{</mo><mtable><mtr><mtd columnalign="left" style="text-align: left"><msub><mi>x</mi><mi>j</mi></msub><mo>=</mo><mn>0</mn></mtd><mtd columnalign="left" style="text-align: left"><mtext mathvariant="normal">(numerical)</mtext></mtd></mtr><mtr><mtd columnalign="left" style="text-align: left"><msub><mi>x</mi><mi>j</mi></msub><mo>=</mo><mtext mathvariant="normal">ref</mtext></mtd><mtd columnalign="left" style="text-align: left"><mtext mathvariant="normal">(categorical)</mtext></mtd></mtr></mtable></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>α</mi><mn>0</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><munder><mo>∑</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mrow><mi>j</mi><mo>:</mo><msub><mi>x</mi><mi>j</mi></msub><mo>=</mo><mn>0</mn></mrow></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mrow><mrow><mtext mathvariant="normal">or </mtext><mspace width="0.333em"></mspace></mrow><msub><mi>x</mi><mi>j</mi></msub><mo>=</mo><mtext mathvariant="normal">ref</mtext></mrow></mtd></mtr></mtable></munder><msub><mi>φ</mi><mi>j</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
\alpha_j(x) &amp;= 0 \text{ when } 
\begin{cases}
x_j = 0 &amp; \text{(numerical)} \\
x_j = \text{ref} &amp; \text{(categorical)}
\end{cases} \\[1em]
\alpha_0(x) &amp;= \sum_{\substack{j: x_j = 0 \\ \text{or } x_j = \text{ref}}} \varphi_j(x)
\end{aligned}
</annotation></semantics></math></p>
</div>
<p><strong>Step 5: Combine</strong></p>
<p>The final IBLM can be interpreted as a collection of adjusted GLMs.
Each row of the data will essentially have its own GLM coefficients.
These are the addition of:</p>
<ol style="list-style-type: decimal">
<li><p>The GLM coefficients derived in step 1, which are the same for
all rows</p></li>
<li><p>The beta corrections derived in step 4, which are unique to that
predictor variable combination.</p></li>
</ol>
<div class="eq-block">
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>μ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>β</mi><mn>0</mn></msub><mo>+</mo><msub><mi>φ</mi><mn>0</mn></msub><mo>+</mo><msub><mi>α</mi><mn>0</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>β</mi><mn>1</mn></msub><mo>+</mo><msub><mi>α</mi><mn>1</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><msub><mi>x</mi><mn>1</mn></msub><mo>+</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>β</mi><mn>2</mn></msub><mo>+</mo><msub><mi>α</mi><mn>2</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><msub><mi>x</mi><mn>2</mn></msub><mo>+</mo><mi>⋯</mi><mo>+</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>β</mi><mi>n</mi></msub><mo>+</mo><msub><mi>α</mi><mi>n</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><msub><mi>x</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">
g(\mu) = (\beta_0 + \varphi_0 + \alpha_0) + (\beta_1 + \alpha_1(x))x_1 + (\beta_2 + \alpha_2(x))x_2 + \cdots + (\beta_n + \alpha_n(x))x_n
</annotation></semantics></math></p>
</div>
<p>or</p>
<div class="eq-block">
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>μ</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mi>β</mi><msub><mi>′</mi><mn>0</mn></msub><mo>+</mo><mi>β</mi><msub><mi>′</mi><mn>1</mn></msub><msub><mi>x</mi><mn>1</mn></msub><mo>+</mo><mi>β</mi><msub><mi>′</mi><mn>2</mn></msub><msub><mi>x</mi><mn>2</mn></msub><mo>+</mo><mi>⋯</mi><mo>+</mo><mi>β</mi><msub><mi>′</mi><mi>n</mi></msub><msub><mi>x</mi><mi>n</mi></msub></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><mrow><mtext mathvariant="normal">where </mtext><mspace width="0.333em"></mspace></mrow><mi>β</mi><msub><mi>′</mi><mi>j</mi></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msub><mi>β</mi><mi>j</mi></msub><mo>+</mo><msub><mi>α</mi><mi>j</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><mrow><mtext mathvariant="normal">and </mtext><mspace width="0.333em"></mspace></mrow><mi>β</mi><msub><mi>′</mi><mn>0</mn></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msub><mi>β</mi><mn>0</mn></msub><mo>+</mo><msub><mi>φ</mi><mn>0</mn></msub><mo>+</mo><msub><mi>α</mi><mn>0</mn></msub></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
g(\mu) &amp;= \beta'_0 + \beta'_1 x_1 + \beta'_2 x_2 + \cdots + \beta'_n x_n \\
\text{where } \beta'_j &amp;= \beta_j + \alpha_j(x) \\
\text{and } \beta'_0 &amp;= \beta_0 + \varphi_0 + \alpha_0
\end{aligned}
</annotation></semantics></math></p>
</div>
<p>Where g(·) is the link function, μ is the expected value of the
response, and β values are your standard regression coefficients.</p>
<p>The IBLM prediction is a combination of components.</p>
<div class="eq-block">
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mtext mathvariant="normal">IBLM prediction</mtext></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msup><mi>g</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>β</mi><msub><mi>′</mi><mn>0</mn></msub><mo>+</mo><mi>β</mi><msub><mi>′</mi><mn>1</mn></msub><msub><mi>x</mi><mn>1</mn></msub><mo>+</mo><mi>β</mi><msub><mi>′</mi><mn>2</mn></msub><msub><mi>x</mi><mn>2</mn></msub><mo>+</mo><mi>⋯</mi><mo>+</mo><mi>β</mi><msub><mi>′</mi><mi>n</mi></msub><msub><mi>x</mi><mi>n</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mrow><mo stretchy="true" form="prefix">{</mo><mtable><mtr><mtd columnalign="left" style="text-align: left"><mtext mathvariant="normal">GLM prediction</mtext><mo>×</mo><mtext mathvariant="normal">Booster prediction</mtext></mtd><mtd columnalign="left" style="text-align: left"><mrow><mtext mathvariant="normal">when </mtext><mspace width="0.333em"></mspace></mrow><mi>g</mi><mo>=</mo><mo>log</mo></mtd></mtr><mtr><mtd columnalign="left" style="text-align: left"><mtext mathvariant="normal">GLM prediction</mtext><mo>+</mo><mtext mathvariant="normal">Booster prediction</mtext></mtd><mtd columnalign="left" style="text-align: left"><mrow><mtext mathvariant="normal">when </mtext><mspace width="0.333em"></mspace></mrow><mi>g</mi><mo>=</mo><mtext mathvariant="normal">identity</mtext></mtd></mtr></mtable></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
\text{IBLM prediction} &amp;= g^{-1} (\beta'_0 + \beta'_1 x_1 + \beta'_2 x_2 + \cdots + \beta'_n x_n) \\[0.5em]
&amp;= \begin{cases}
\text{GLM prediction} \times \text{Booster prediction} &amp; \text{when } g = \log \\
\text{GLM prediction} + \text{Booster prediction} &amp; \text{when } g = \text{identity}
\end{cases}
\end{aligned}
</annotation></semantics></math></p>
</div>
<p>This preserves the familiar GLM form while incorporating the
booster’s superior predictive power.</p>
</div>
<div class="section level2">
<h2 id="train">Train<a class="anchor" aria-label="anchor" href="#train"></a>
</h2>
<p>To train an IBLM we must get our data into an appropriate format. In
this document our demonstrations will be completed using French motor
claims dataset <code>freMTPL2freq</code>.</p>
<p>Data for training an IBLM model must be in the form of a list of 3
dataframes. These will be named “train”, “validate” and “test”. The
function <code><a href="../reference/split_into_train_validate_test.html">split_into_train_validate_test()</a></code> can conveniently
split a single dataframe into such a structure.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_freMTPL2freq.html">load_freMTPL2freq</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">|&gt;</span> <span class="fu">mutate</span><span class="op">(</span>ClaimNb <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">ClaimNb</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df_list</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/split_into_train_validate_test.html">split_into_train_validate_test</a></span><span class="op">(</span>seed <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>There is currently only one function available to train an IBLM. This
is <code><a href="../reference/train_iblm_xgb.html">train_iblm_xgb()</a></code> which will use xgboost as the booster
model. This performs steps 1 and 2 of the <a href="#theory">Theory</a>.</p>
<p>The output is of class “iblm”. Objects of this class contain two
component models “glm_model” and “booster_model”. There are also other
items containing information (see Value section of
<code><a href="../reference/train_iblm_xgb.html">train_iblm_xgb()</a></code> for more information)</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iblm_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/train_iblm_xgb.html">train_iblm_xgb</a></span><span class="op">(</span></span>
<span>  <span class="va">df_list</span>,</span>
<span>  response_var <span class="op">=</span> <span class="st">"ClaimNb"</span>,</span>
<span>  family <span class="op">=</span> <span class="st">"poisson"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">iblm_model</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "iblm"</span></span></code></pre></div>
<p>For convenience, it is also possible to train an XGBoost model using
the same settings that were used for you model of class “iblm”. This can
be useful when directly comparing (for example see <a href="#pinball-score">Pinball Score</a>)</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xgb_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/train_xgb_as_per_iblm.html">train_xgb_as_per_iblm</a></span><span class="op">(</span><span class="va">iblm_model</span><span class="op">)</span></span>
<span></span>
<span><span class="va">is_identical_config</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html" class="external-link">map2_lgl</a></span><span class="op">(</span></span>
<span>  <span class="fu">xgboost</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.config.html" class="external-link">xgb.config</a></span><span class="op">(</span><span class="va">xgb_model</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu">xgboost</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.config.html" class="external-link">xgb.config</a></span><span class="op">(</span><span class="va">iblm_model</span><span class="op">$</span><span class="va">booster_model</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">identical</span></span>
<span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># the config is mostly identical. In our example the differences are:</span></span>
<span><span class="va">is_identical_config</span><span class="op">[</span><span class="op">!</span><span class="va">is_identical_config</span><span class="op">]</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "learner.generic_param.random_state"                   </span></span>
<span><span class="co">#&gt; [2] "learner.generic_param.seed"                           </span></span>
<span><span class="co">#&gt; [3] "learner.gradient_booster.gbtree_model_param.num_trees"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="explain">Explain<a class="anchor" aria-label="anchor" href="#explain"></a>
</h2>
<p>Code to explain and interpret an object of class “iblm” are
conveniently wrapped in the <code><a href="../reference/explain_iblm.html">explain_iblm()</a></code> function. This
performs steps 3, 4 and 5 of the <a href="#theory">Theory</a>. The
values derived are all based on the data fed in, which would usually be
the test portion of your dataset.</p>
<p>The following line is all that is required:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ex</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain_iblm.html">explain_iblm</a></span><span class="op">(</span><span class="va">iblm_model</span>, <span class="va">df_list</span><span class="op">$</span><span class="va">test</span><span class="op">)</span></span></code></pre></div>
<p>The output object is a list containing the following items:</p>
<ul>
<li><p><strong>beta_corrected_scatter</strong> Function to create
scatter plots showing SHAP corrections vs variable values (see
<code><a href="../reference/beta_corrected_scatter.html">beta_corrected_scatter()</a></code>)</p></li>
<li><p><strong>beta_corrected_density</strong> Function to create
density plots of SHAP corrections for variables (see
<code><a href="../reference/beta_corrected_density.html">beta_corrected_density()</a></code>)</p></li>
<li><p><strong>bias_density</strong> Function to create density plots of
SHAP corrections migrated to bias (see
<code><a href="../reference/bias_density.html">bias_density()</a></code>)</p></li>
<li><p><strong>overall_correction</strong> Function to show global
correction distributions (see
<code><a href="../reference/overall_correction.html">overall_correction()</a></code>)</p></li>
<li><p><strong>shap</strong> Dataframe showing raw SHAP values of data
records. These are the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>φ</mi><mi>n</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\varphi_n(x)</annotation></semantics></math>
values described in step 3 of <a href="#theory">Theory</a>.</p></li>
<li><p><strong>beta_corrections</strong> Dataframe showing beta
corrections (in wide/one-hot format) of data records. These are the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mn>0</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\alpha_0(x)</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mi>j</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\alpha_j(x)</annotation></semantics></math>
values described in step 4 of <a href="#theory">Theory</a>.</p></li>
<li><p><strong>data_beta_coeff</strong> Dataframe showing corrected beta
coefficients of data records. These are the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>β</mi><msub><mi>′</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">\beta'_0</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>β</mi><msub><mi>′</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">\beta'_j</annotation></semantics></math>
values described in step 5 of <a href="#theory">Theory</a>. For
categorical variables, the value corresponds to the relevant coefficient
for that datapoint.</p></li>
</ul>
<p>Many of the items output are functions. The functions can then be
called to observe the components of the “iblm” object in different
ways.</p>
<div class="section level3">
<h3 id="beta-corrected-density">Beta Corrected Density<a class="anchor" aria-label="anchor" href="#beta-corrected-density"></a>
</h3>
<p>The corrected beta coefficients (β’ⱼ) can be observed in a density
plot. This plotting function allows the user to see corrected beta
coefficient values for a particular variable.</p>
<p>The density plot also shows the standard error for the original beta
coefficient, fitted in the GLM model component. This can be useful to
understanding the significance of the range in corrected beta
coefficients.</p>
<div class="section level4">
<h4 id="numerical-variables">Numerical Variables<a class="anchor" aria-label="anchor" href="#numerical-variables"></a>
</h4>
<p>For numerical variables, calling the function creates a single plot.
Below we show examples with different numerical variables from our
freMTPL2freq dataset.</p>
</div>
</div>
<div class="section level3 tabset">
<h3 class="tabset" id="section"></h3>




<ul class="nav nav-tabs" id="section" role="tablist">
<li role="presentation" class="nav-item"><button data-bs-toggle="tab" data-bs-target="#vehpower" id="vehpower-tab" type="button" role="tab" aria-controls="vehpower" aria-selected="true" class="active nav-link">VehPower</button></li>
<li role="presentation" class="nav-item"><button data-bs-toggle="tab" data-bs-target="#vehage" id="vehage-tab" type="button" role="tab" aria-controls="vehage" aria-selected="false" class="nav-link">VehAge</button></li>
<li role="presentation" class="nav-item"><button data-bs-toggle="tab" data-bs-target="#drivage" id="drivage-tab" type="button" role="tab" aria-controls="drivage" aria-selected="false" class="nav-link">DrivAge</button></li>
<li role="presentation" class="nav-item"><button data-bs-toggle="tab" data-bs-target="#bonusmalus" id="bonusmalus-tab" type="button" role="tab" aria-controls="bonusmalus" aria-selected="false" class="nav-link">BonusMalus</button></li>
</ul>
<div class="tab-content">
<div class="active  tab-pane" id="vehpower" role="tabpanel" aria-labelledby="vehpower-tab">

<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ex</span><span class="op">$</span><span class="fu">beta_corrected_density</span><span class="op">(</span>varname <span class="op">=</span> <span class="st">"VehPower"</span><span class="op">)</span></span></code></pre></div>
<p><img src="IBLM_files/figure-html/explain-beta_correct_density-VehPower-1.png" class="r-plt" width="672" style="display: block; margin: auto;"></p>
</div>
<div class="tab-pane" id="vehage" role="tabpanel" aria-labelledby="vehage-tab">

<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ex</span><span class="op">$</span><span class="fu">beta_corrected_density</span><span class="op">(</span>varname <span class="op">=</span> <span class="st">"VehAge"</span><span class="op">)</span></span></code></pre></div>
<p><img src="IBLM_files/figure-html/explain-beta_correct_density-VehAge-1.png" class="r-plt" width="672" style="display: block; margin: auto;"></p>
</div>
<div class="tab-pane" id="drivage" role="tabpanel" aria-labelledby="drivage-tab">

<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ex</span><span class="op">$</span><span class="fu">beta_corrected_density</span><span class="op">(</span>varname <span class="op">=</span> <span class="st">"DrivAge"</span><span class="op">)</span></span></code></pre></div>
<p><img src="IBLM_files/figure-html/explain-beta_correct_density-DrivAge-1.png" class="r-plt" width="672" style="display: block; margin: auto;"></p>
</div>
<div class="tab-pane" id="bonusmalus" role="tabpanel" aria-labelledby="bonusmalus-tab">

<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ex</span><span class="op">$</span><span class="fu">beta_corrected_density</span><span class="op">(</span>varname <span class="op">=</span> <span class="st">"BonusMalus"</span><span class="op">)</span></span></code></pre></div>
<p><img src="IBLM_files/figure-html/explain-beta_correct_density-BonusMalus-1.png" class="r-plt" width="672" style="display: block; margin: auto;"></p>
</div>
</div>
</div>
<div class="section level3">
<h3 id="section-1"></h3>
<div class="section level4">
<h4 id="categorical-variables">Categorical Variables<a class="anchor" aria-label="anchor" href="#categorical-variables"></a>
</h4>
<p>For categorical variables, calling the function creates a
<strong>list</strong> of ggplot objects. A separate plot is produced for
each level of that categorical variable. Note this does not include the
reference level.</p>
<p>In the example below “VehBrand” has 11 levels and produces 10 plots.
Level “B1” was a reference level and does not have a beta coefficient
within the GLM component. Instead, for “B1”, the SHAP values are
migrated to the bias (see <a href="#bias-corrected-density">Bias
Corrected Density</a>). Also in the example, we have wrapped our list
using patchwork to create a single graphic for simplicity.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">VehBrand</span> <span class="op">&lt;-</span> <span class="va">ex</span><span class="op">$</span><span class="fu">beta_corrected_density</span><span class="op">(</span>varname <span class="op">=</span> <span class="st">"VehBrand"</span>, type <span class="op">=</span> <span class="st">"hist"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">VehBrand</span> <span class="op">|&gt;</span> <span class="fu">patchwork</span><span class="fu">::</span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/wrap_plots.html" class="external-link">wrap_plots</a></span><span class="op">(</span>ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> </span></code></pre></div>
<p><img src="IBLM_files/figure-html/beta_correct_density-cat-1.png" class="r-plt" width="1152" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level3">
<h3 id="beta-corrected-scatter">Beta Corrected Scatter<a class="anchor" aria-label="anchor" href="#beta-corrected-scatter"></a>
</h3>
<p>The corrected beta coefficients (β’ⱼ) can be observed in a scatter
plot (or boxplot). This plotting function allows the user to see
corrected beta coefficient values for a particular variable and the
relationship to that particlar variable value.</p>
<div class="section level4">
<h4 id="numerical-variables-1">Numerical Variables<a class="anchor" aria-label="anchor" href="#numerical-variables-1"></a>
</h4>
<p>When varname is set to a numerical variable, a scatter plot is
produced. The example below shows the relationship of corrected beta
coefficient values against driver age. Note that the original beta
coefficient fitted to the GLM component is shown by a dashed black line
(and stated near the top of the plot in orange). We can see that
corrected beta coefficients can be materially different. There is also a
smoothed trend line fitted that shows the overall pattern of
correction.</p>
<p>Note the color argument can also be set to try and observe
interactions with a second variable.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ex</span><span class="op">$</span><span class="fu">beta_corrected_scatter</span><span class="op">(</span>varname <span class="op">=</span> <span class="st">"DrivAge"</span>, color <span class="op">=</span> <span class="st">"VehPower"</span><span class="op">)</span></span>
<span><span class="co">#&gt; `geom_smooth()` using method = 'gam' and formula = 'y ~ s(x, bs = "cs")'</span></span></code></pre></div>
<p><img src="IBLM_files/figure-html/explain-beta_correct_scatter-num-1.png" class="r-plt" width="672" style="display: block; margin: auto;"></p>
</div>
<div class="section level4">
<h4 id="categorical-variables-1">Categorical Variables<a class="anchor" aria-label="anchor" href="#categorical-variables-1"></a>
</h4>
<p>When varname is set to a categorical variable, a boxplot is produced.
This shows the distribution for each individual level within that
categorical variable.</p>
<p>Note the color argument can also be set to try and observe
interactions with a second variable.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ex</span><span class="op">$</span><span class="fu">beta_corrected_scatter</span><span class="op">(</span>varname <span class="op">=</span> <span class="st">"VehBrand"</span><span class="op">)</span></span></code></pre></div>
<p><img src="IBLM_files/figure-html/explain-beta_correct_scatter-cat-1.png" class="r-plt" width="672" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level3">
<h3 id="bias-corrected-density">Bias Corrected Density<a class="anchor" aria-label="anchor" href="#bias-corrected-density"></a>
</h3>
<p>As described in step 4 of <a href="#theory">Theory</a>, some shap
values cannot be translated to beta corrections. These values are
instead migrated to the bias. There are two situations where this can
occur:</p>
<ol style="list-style-type: decimal">
<li>Numerical variable where the value was zero for that data
point.</li>
<li>Categorical variable where the value was the reference level for
that data point.</li>
</ol>
<p>In the <code>bias_correction_var</code> plot we visualise all the
individual times this occured in our test dataset. For categorical
variables Area, Region, VehBrand and VehGas the total counts in the
repsective facets of the histogram will equal the total occurences of
the reference level for that variable. For numerical variable VehAge the
total count in that facet will equal the total occurences of zero for
VehAge in the dataset. Other numerical variables are dropped from the
plot as they had no instances of zero value (for example DrivAge)</p>
<p>The <code>bias_correction_total</code> plot is the cumulative sum of
these components across each data point. Note any data point with no
bias migration (i.e. conditions 1 and 2 do not occur) will have the
standard bias adjustment and is not counted in the plot. The standard
bias value, along with standard error around this, can be observed as
the straight blue line and dashed orange lines either side.</p>
<p>The bias values can be observed with <code><a href="../reference/bias_density.html">bias_density()</a></code>.</p>
</div>
<div class="section level3 tabset">
<h3 class="tabset" id="section-2"></h3>


<ul class="nav nav-tabs" id="section-2" role="tablist">
<li role="presentation" class="nav-item"><button data-bs-toggle="tab" data-bs-target="#variable" id="variable-tab" type="button" role="tab" aria-controls="variable" aria-selected="true" class="active nav-link">Variable</button></li>
<li role="presentation" class="nav-item"><button data-bs-toggle="tab" data-bs-target="#total" id="total-tab" type="button" role="tab" aria-controls="total" aria-selected="false" class="nav-link">Total</button></li>
</ul>
<div class="tab-content">
<div class="active  tab-pane" id="variable" role="tabpanel" aria-labelledby="variable-tab">

<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bias_corrections</span> <span class="op">&lt;-</span> <span class="va">ex</span><span class="op">$</span><span class="fu">bias_density</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">bias_corrections</span><span class="op">$</span><span class="va">bias_correction_var</span></span></code></pre></div>
<p><img src="IBLM_files/figure-html/explain-bias_density-var-1.png" class="r-plt" width="672" style="display: block; margin: auto;"></p>
</div>
<div class="tab-pane" id="total" role="tabpanel" aria-labelledby="total-tab">

<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bias_corrections</span> <span class="op">&lt;-</span> <span class="va">ex</span><span class="op">$</span><span class="fu">bias_density</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">bias_corrections</span><span class="op">$</span><span class="va">bias_correction_total</span></span></code></pre></div>
<p><img src="IBLM_files/figure-html/explain-bias_density-total-1.png" class="r-plt" width="672" style="display: block; margin: auto;"></p>
</div>
</div>
</div>
<div class="section level3">
<h3 id="section-3"></h3>
</div>
<div class="section level3">
<h3 id="overall-correction">Overall Correction<a class="anchor" aria-label="anchor" href="#overall-correction"></a>
</h3>
<p>The distribution of overall corrections across your test data can be
observed. If the link function is log then the correction is a
multiplier (as is the case below). If the link function is identity,
then the overall correction is an addition. By default the x scale is
transformed by the link function, but this can be switched off.</p>
</div>
<div class="section level3 tabset">
<h3 class="tabset" id="section-4"></h3>


<ul class="nav nav-tabs" id="section-4" role="tablist">
<li role="presentation" class="nav-item"><button data-bs-toggle="tab" data-bs-target="#link-transformed" id="link-transformed-tab" type="button" role="tab" aria-controls="link-transformed" aria-selected="true" class="active nav-link">Link Transformed</button></li>
<li role="presentation" class="nav-item"><button data-bs-toggle="tab" data-bs-target="#not-transformed" id="not-transformed-tab" type="button" role="tab" aria-controls="not-transformed" aria-selected="false" class="nav-link">Not transformed</button></li>
</ul>
<div class="tab-content">
<div class="active  tab-pane" id="link-transformed" role="tabpanel" aria-labelledby="link-transformed-tab">

<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ex</span><span class="op">$</span><span class="fu">overall_correction</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="IBLM_files/figure-html/explain-overall_correction-log-1.png" class="r-plt" width="672" style="display: block; margin: auto;"></p>
</div>
<div class="tab-pane" id="not-transformed" role="tabpanel" aria-labelledby="not-transformed-tab">

<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ex</span><span class="op">$</span><span class="fu">overall_correction</span><span class="op">(</span>transform_x_scale_by_link <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="IBLM_files/figure-html/explain-overall_correction-identity-1.png" class="r-plt" width="672" style="display: block; margin: auto;"></p>
</div>
</div>
</div>
<div class="section level3">
<h3 id="section-5"></h3>
</div>
</div>
<div class="section level2">
<h2 id="predict">Predict<a class="anchor" aria-label="anchor" href="#predict"></a>
</h2>
<p>The package contains a predict method for the class “iblm”. This
employs the <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> method of both the “glm_model” and
“booster_model” items within the “iblm” class object.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">predictions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">iblm_model</span>, <span class="va">df_list</span><span class="op">$</span><span class="va">test</span><span class="op">)</span></span></code></pre></div>
<p>The predict method contains an option to trim. This truncates the
values of the booster model predictions to prevent extreme deviation
from the foundation GLM. This is explored further in <a href="#correction-corridor">Correction Corridor</a>.</p>
<p>Because IBLM is essentially a collection of GLMs, and the corrected
beta coefficients are derived by the <code><a href="../reference/explain_iblm.html">explain_iblm()</a></code>
function, it is also possible to predict through linear calculation.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">coeff_multiplier</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">df_list</span><span class="op">$</span><span class="va">test</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="fu">all_of</span><span class="op">(</span><span class="st">"ClaimNb"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    <span class="fu">across</span><span class="op">(</span></span>
<span>      <span class="fu">all_of</span><span class="op">(</span><span class="va">iblm_model</span><span class="op">$</span><span class="va">predictor_vars</span><span class="op">$</span><span class="va">categorical</span><span class="op">)</span>,</span>
<span>      <span class="op">~</span><span class="fl">1</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>bias <span class="op">=</span> <span class="fl">1</span>, .before <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">predictions_alt</span> <span class="op">&lt;-</span> </span>
<span>  <span class="op">(</span><span class="va">ex</span><span class="op">$</span><span class="va">data_beta_coeff</span> <span class="op">*</span> <span class="va">coeff_multiplier</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># difference in predictions very small between two alternative methods</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">predictions_alt</span> <span class="op">/</span> <span class="va">predictions</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -1.422597e-06  8.286781e-07</span></span></code></pre></div>
<div class="section level3">
<h3 id="pinball-score">Pinball Score<a class="anchor" aria-label="anchor" href="#pinball-score"></a>
</h3>
<p>The pinball score is a way to measure the performance of the models.
It shows the increase (or decrease when negative) of predictability
compared to using the training data mean instead.</p>
<p>In the example below, we see the iblm has increased score compared to
the glm. We have also added the xgb_model (derived in section <a href="#train">Train</a>) as a further comparison.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/get_pinball_scores.html">get_pinball_scores</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">df_list</span><span class="op">$</span><span class="va">test</span>, </span>
<span>  iblm_model <span class="op">=</span> <span class="va">iblm_model</span>,</span>
<span>  additional_models <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>xgb <span class="op">=</span> <span class="va">xgb_model</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">gt</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">fmt_percent</span><span class="op">(</span><span class="st">"pinball_score"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): NAs introduced by coercion</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): NAs introduced by coercion</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): NAs introduced by coercion</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): NAs introduced by coercion</span></span></code></pre></div>
<div id="kmpfzvwrqh" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#kmpfzvwrqh table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#kmpfzvwrqh thead, #kmpfzvwrqh tbody, #kmpfzvwrqh tfoot, #kmpfzvwrqh tr, #kmpfzvwrqh td, #kmpfzvwrqh th {
  border-style: none;
}

#kmpfzvwrqh p {
  margin: 0;
  padding: 0;
}

#kmpfzvwrqh .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#kmpfzvwrqh .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#kmpfzvwrqh .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#kmpfzvwrqh .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#kmpfzvwrqh .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#kmpfzvwrqh .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#kmpfzvwrqh .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#kmpfzvwrqh .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#kmpfzvwrqh .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#kmpfzvwrqh .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#kmpfzvwrqh .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#kmpfzvwrqh .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#kmpfzvwrqh .gt_spanner_row {
  border-bottom-style: hidden;
}

#kmpfzvwrqh .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#kmpfzvwrqh .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#kmpfzvwrqh .gt_from_md > :first-child {
  margin-top: 0;
}

#kmpfzvwrqh .gt_from_md > :last-child {
  margin-bottom: 0;
}

#kmpfzvwrqh .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#kmpfzvwrqh .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#kmpfzvwrqh .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#kmpfzvwrqh .gt_row_group_first td {
  border-top-width: 2px;
}

#kmpfzvwrqh .gt_row_group_first th {
  border-top-width: 2px;
}

#kmpfzvwrqh .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#kmpfzvwrqh .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#kmpfzvwrqh .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#kmpfzvwrqh .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#kmpfzvwrqh .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#kmpfzvwrqh .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#kmpfzvwrqh .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#kmpfzvwrqh .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#kmpfzvwrqh .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#kmpfzvwrqh .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#kmpfzvwrqh .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#kmpfzvwrqh .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#kmpfzvwrqh .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#kmpfzvwrqh .gt_left {
  text-align: left;
}

#kmpfzvwrqh .gt_center {
  text-align: center;
}

#kmpfzvwrqh .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#kmpfzvwrqh .gt_font_normal {
  font-weight: normal;
}

#kmpfzvwrqh .gt_font_bold {
  font-weight: bold;
}

#kmpfzvwrqh .gt_font_italic {
  font-style: italic;
}

#kmpfzvwrqh .gt_super {
  font-size: 65%;
}

#kmpfzvwrqh .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#kmpfzvwrqh .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#kmpfzvwrqh .gt_indent_1 {
  text-indent: 5px;
}

#kmpfzvwrqh .gt_indent_2 {
  text-indent: 10px;
}

#kmpfzvwrqh .gt_indent_3 {
  text-indent: 15px;
}

#kmpfzvwrqh .gt_indent_4 {
  text-indent: 20px;
}

#kmpfzvwrqh .gt_indent_5 {
  text-indent: 25px;
}

#kmpfzvwrqh .katex-display {
  display: inline-flex !important;
  margin-bottom: 0.75em !important;
}

#kmpfzvwrqh div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {
  height: 0px !important;
}
</style>
<table class="table gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead><tr class="gt_col_headings">
<th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id="model">model</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="poisson_deviance">poisson_deviance</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="pinball_score">pinball_score</th>
    </tr></thead>
<tbody class="gt_table_body">
<tr>
<td headers="model" class="gt_row gt_left">homog</td>
<td headers="poisson_deviance" class="gt_row gt_right">1.407148</td>
<td headers="pinball_score" class="gt_row gt_right">0.00%</td>
</tr>
<tr>
<td headers="model" class="gt_row gt_left">glm</td>
<td headers="poisson_deviance" class="gt_row gt_right">1.348394</td>
<td headers="pinball_score" class="gt_row gt_right">4.18%</td>
</tr>
<tr>
<td headers="model" class="gt_row gt_left">iblm</td>
<td headers="poisson_deviance" class="gt_row gt_right">1.238663</td>
<td headers="pinball_score" class="gt_row gt_right">11.97%</td>
</tr>
<tr>
<td headers="model" class="gt_row gt_left">xgb</td>
<td headers="poisson_deviance" class="gt_row gt_right">1.363077</td>
<td headers="pinball_score" class="gt_row gt_right">3.13%</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section level3">
<h3 id="correction-corridor">Correction Corridor<a class="anchor" aria-label="anchor" href="#correction-corridor"></a>
</h3>
<p>As described in <a href="#predict">Predict</a> it is possible to trim
the contribution from the booster component of an iblm object when
predicting. This prevents estimates deviating too far from the GLM
foundational model.</p>
<p>The correction corridor function applies <code><a href="../reference/predict.iblm.html">predict.iblm()</a></code>
with different settings of trim, and plots the results. It is also
possible to set the color to a variable to observe any patterns. Note
that when the trim value is zero, the IBLM predictions are the same as
the GLM predictions.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/correction_corridor.html">correction_corridor</a></span><span class="op">(</span></span>
<span>  <span class="va">iblm_model</span>, </span>
<span>  <span class="va">df_list</span><span class="op">$</span><span class="va">test</span>,</span>
<span>  trim_vals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>  sample_perc <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>  color <span class="op">=</span> <span class="st">"DrivAge"</span><span class="op">)</span></span></code></pre></div>
<p><img src="IBLM_files/figure-html/correction-corridor-1.png" class="r-plt" width="672" style="display: block; margin: auto;"></p>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Karol Gawlowski, Paul Beard.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
